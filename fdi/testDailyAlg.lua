require 'calculate_fdi'

local filePath = './fdi/fixtures/graphs_of_interest.txt'
--local filePath = './fixtures/graphs_of_interest.txt'

local matlab = {
[1] = { [1] = {57, 3}, [2] = {58, 3}, [3] = {59, 3}, [4] = {63, 3}, [5] = {64, 3}, [6] = {72, 3}, [7] = {73, 3}, [8] = {78, 3}, [9] = {83, 2}, [10] = {84, 2}, [11] = {85, 1}, [12] = {88, 1}, [13] = {89, 1}, [14] = {90, 3}, [15] = {91, 1}, [16] = {95, 3}, [17] = {96, 2}, [18] = {105, 3}, [19] = {128, 3}, [20] = {129, 3}, [21] = {155, 3}, [22] = {159, 3}, [23] = {160, 3}, [24] = {173, 3}, [25] = {174, 3}, [26] = {193, 3}, [27] = {194, 3}, [28] = {195, 3}, [29] = {197, 3}, [30] = {198, 3}, [31] = {225, 2}, [32] = {226, 1}, [33] = {227, 2}, [34] = {228, 2}, [35] = {237, 2}, [36] = {238, 1}, [37] = {241, 1}, [38] = {242, 1}, [39] = {255, 2}, [40] = {311, 3}, [41] = {328, 2}, [42] = {334, 2}},
[2] = { [1] = {46, 3}, [2] = {59, 3}, [3] = {60, 3}, [4] = {65, 3}, [5] = {66, 3}, [6] = {83, 1}, [7] = {84, 2}, [8] = {85, 2}, [9] = {86, 3}, [10] = {89, 1}, [11] = {90, 3}, [12] = {91, 3}, [13] = {92, 3}, [14] = {94, 3}, [15] = {95, 3}, [16] = {118, 3}, [17] = {120, 3}, [18] = {121, 3}, [19] = {136, 3}, [20] = {149, 3}, [21] = {176, 2}, [22] = {225, 2}, [23] = {228, 2}, [24] = {229, 2}, [25] = {230, 2}, [26] = {231, 2}, [27] = {237, 2}, [28] = {238, 2}, [29] = {240, 2}, [30] = {241, 2}, [31] = {244, 1}, [32] = {311, 2}, [33] = {334, 2}},
[3] = { [1] = {45, 3}, [2] = {47, 3}, [3] = {48, 3}, [4] = {67, 3}, [5] = {68, 3}, [6] = {72, 3}, [7] = {73, 3}, [8] = {74, 3}, [9] = {78, 3}, [10] = {79, 3}, [11] = {86, 3}, [12] = {87, 3}, [13] = {98, 3}, [14] = {99, 3}, [15] = {100, 3}, [16] = {101, 3}, [17] = {105, 2}, [18] = {107, 3}, [19] = {108, 3}, [20] = {112, 1}, [21] = {113, 3}, [22] = {114, 3}, [23] = {115, 2}, [24] = {177, 1}, [25] = {204, 2}, [26] = {205, 2}, [27] = {229, 2}, [28] = {230, 2}, [29] = {234, 1}, [30] = {235, 1}, [31] = {236, 2}, [32] = {237, 1}, [33] = {254, 1}, [34] = {255, 3}, [35] = {261, 1}, [36] = {262, 1}, [37] = {263, 1}, [38] = {264, 1}, [39] = {311, 3}, [40] = {316, 2}, [41] = {322, 2}, [42] = {323, 2}, [43] = {324, 2}, [44] = {325, 2}, [45] = {329, 2}, [46] = {331, 2}, [47] = {332, 2}, [48] = {333, 2}, [49] = {334, 2}},
[4] = { [1] = {18, 1}, [2] = {19, 1}, [3] = {25, 1}, [4] = {26, 1}, [5] = {53, 1}, [6] = {75, 2}, [7] = {146, 1}, [8] = {147, 1}, [9] = {148, 1}, [10] = {149, 1}, [11] = {311, 2}},
[5] = { [1] = {21, 2}, [2] = {26, 1}, [3] = {27, 1}, [4] = {28, 1}, [5] = {65, 3}, [6] = {106, 2}, [7] = {107, 2}, [8] = {108, 2}, [9] = {109, 2}, [10] = {198, 1}, [11] = {199, 2}, [12] = {200, 1}, [13] = {206, 1}, [14] = {248, 2}, [15] = {251, 2}, [16] = {252, 1}, [17] = {253, 2}, [18] = {254, 2}, [19] = {260, 2}, [20] = {261, 1}, [21] = {263, 2}, [22] = {264, 2}, [23] = {267, 1}, [24] = {268, 1}, [25] = {311, 1}, [26] = {325, 1}, [27] = {334, 2}, [28] = {342, 1}, [29] = {343, 1}, [30] = {344, 1}, [31] = {345, 1}, [32] = {357, 1}},
[6] = { [1] = {17, 3}, [2] = {18, 3}, [3] = {24, 3}, [4] = {25, 3}},
[7] = { [1] = {49, 1}, [2] = {54, 1}, [3] = {82, 3}, [4] = {83, 3}, [5] = {87, 1}, [6] = {88, 1}, [7] = {89, 1}, [8] = {102, 1}, [9] = {104, 2}, [10] = {142, 3}, [11] = {143, 3}, [12] = {151, 3}, [13] = {152, 3}, [14] = {155, 3}, [15] = {168, 2}, [16] = {171, 1}, [17] = {172, 2}, [18] = {173, 2}, [19] = {174, 2}, [20] = {178, 1}, [21] = {179, 1}, [22] = {180, 1}, [23] = {184, 1}, [24] = {185, 1}, [25] = {186, 1}, [26] = {187, 1}, [27] = {190, 2}, [28] = {191, 2}, [29] = {192, 2}, [30] = {193, 1}, [31] = {203, 1}, [32] = {204, 1}, [33] = {205, 1}, [34] = {228, 1}, [35] = {229, 1}, [36] = {230, 1}, [37] = {231, 1}, [38] = {241, 1}, [39] = {242, 1}, [40] = {251, 1}, [41] = {258, 2}, [42] = {259, 2}, [43] = {286, 1}, [44] = {287, 1}, [45] = {288, 1}, [46] = {311, 2}, [47] = {315, 1}, [48] = {324, 1}, [49] = {325, 1}, [50] = {326, 1}, [51] = {327, 1}},
[8] = { [1] = {43, 3}, [2] = {44, 3}, [3] = {76, 3}, [4] = {77, 3}, [5] = {82, 3}, [6] = {84, 3}, [7] = {85, 3}, [8] = {92, 3}, [9] = {93, 3}, [10] = {99, 3}, [11] = {100, 3}, [12] = {101, 1}, [13] = {102, 1}, [14] = {133, 3}, [15] = {134, 3}, [16] = {135, 3}, [17] = {159, 2}, [18] = {171, 1}, [19] = {175, 1}, [20] = {176, 2}, [21] = {177, 1}, [22] = {178, 1}, [23] = {180, 3}, [24] = {191, 1}, [25] = {192, 1}, [26] = {193, 1}, [27] = {194, 1}, [28] = {197, 1}, [29] = {198, 1}, [30] = {199, 1}, [31] = {200, 1}, [32] = {236, 1}, [33] = {255, 2}, [34] = {286, 1}, [35] = {311, 3}, [36] = {328, 1}, [37] = {333, 1}, [38] = {334, 2}},
[9] = { [1] = {42, 3}, [2] = {48, 3}, [3] = {61, 3}, [4] = {62, 3}, [5] = {64, 3}, [6] = {65, 3}, [7] = {70, 3}, [8] = {71, 3}, [9] = {72, 3}, [10] = {86, 3}, [11] = {87, 3}, [12] = {88, 3}, [13] = {89, 3}, [14] = {95, 3}, [15] = {96, 3}, [16] = {105, 1}, [17] = {106, 3}, [18] = {110, 3}, [19] = {111, 3}, [20] = {112, 3}, [21] = {116, 3}, [22] = {117, 3}, [23] = {121, 3}, [24] = {123, 3}, [25] = {124, 3}, [26] = {125, 3}, [27] = {131, 2}, [28] = {148, 3}, [29] = {149, 3}, [30] = {170, 1}, [31] = {171, 1}, [32] = {172, 2}, [33] = {173, 2}, [34] = {177, 1}, [35] = {182, 3}, [36] = {183, 3}, [37] = {184, 3}, [38] = {190, 3}, [39] = {191, 3}, [40] = {192, 1}, [41] = {193, 1}, [42] = {195, 3}, [43] = {196, 3}, [44] = {205, 1}, [45] = {236, 1}, [46] = {250, 1}, [47] = {255, 2}, [48] = {286, 1}, [49] = {311, 3}, [50] = {327, 1}, [51] = {328, 1}, [52] = {332, 1}, [53] = {333, 1}, [54] = {334, 2}},
[10] = { [1] = {42, 3}, [2] = {46, 3}, [3] = {47, 3}, [4] = {51, 3}, [5] = {52, 3}, [6] = {57, 3}, [7] = {58, 3}, [8] = {84, 1}, [9] = {85, 1}, [10] = {86, 1}, [11] = {87, 1}, [12] = {94, 2}, [13] = {95, 2}, [14] = {96, 2}, [15] = {97, 2}, [16] = {102, 2}, [17] = {103, 2}, [18] = {104, 2}, [19] = {105, 2}, [20] = {116, 3}, [21] = {117, 3}, [22] = {118, 3}, [23] = {147, 3}, [24] = {148, 3}, [25] = {175, 1}, [26] = {176, 2}, [27] = {177, 1}, [28] = {210, 1}, [29] = {227, 1}, [30] = {228, 1}, [31] = {229, 1}, [32] = {230, 1}, [33] = {238, 1}, [34] = {241, 1}, [35] = {246, 1}, [36] = {247, 1}, [37] = {248, 1}, [38] = {255, 2}, [39] = {300, 1}, [40] = {301, 1}, [41] = {311, 2}, [42] = {318, 2}, [43] = {319, 2}, [44] = {320, 2}, [45] = {321, 2}, [46] = {323, 2}, [47] = {324, 2}, [48] = {325, 2}, [49] = {326, 2}, [50] = {330, 2}, [51] = {334, 2}},
[11] = { [1] = {164, 3}, [2] = {165, 3}, [3] = {166, 3}, [4] = {167, 3}, [5] = {217, 3}, [6] = {240, 2}},
[12] = { [1] = {55, 3}, [2] = {56, 3}, [3] = {83, 2}, [4] = {84, 2}, [5] = {85, 2}, [6] = {86, 2}, [7] = {90, 3}, [8] = {91, 3}, [9] = {102, 3}, [10] = {103, 3}, [11] = {104, 3}, [12] = {225, 2}, [13] = {228, 1}, [14] = {229, 1}, [15] = {230, 1}, [16] = {231, 1}, [17] = {237, 2}, [18] = {238, 2}, [19] = {240, 2}, [20] = {241, 2}, [21] = {242, 2}, [22] = {244, 2}, [23] = {245, 2}, [24] = {246, 2}, [25] = {247, 2}, [26] = {311, 2}, [27] = {334, 2}},
[13] = { [1] = {19, 1}, [2] = {20, 1}, [3] = {21, 1}, [4] = {25, 1}, [5] = {26, 1}, [6] = {31, 1}, [7] = {32, 1}, [8] = {33, 1}, [9] = {54, 2}, [10] = {110, 2}, [11] = {133, 2}},
[14] = { [1] = {49, 3}, [2] = {50, 3}, [3] = {52, 3}, [4] = {53, 3}, [5] = {65, 3}, [6] = {70, 3}, [7] = {71, 3}, [8] = {76, 3}, [9] = {83, 1}, [10] = {84, 2}, [11] = {85, 2}, [12] = {86, 2}, [13] = {94, 3}, [14] = {95, 3}, [15] = {96, 3}, [16] = {100, 3}, [17] = {101, 3}, [18] = {105, 3}, [19] = {115, 3}, [20] = {116, 3}, [21] = {118, 3}, [22] = {126, 3}, [23] = {127, 3}, [24] = {162, 2}, [25] = {163, 1}, [26] = {172, 3}, [27] = {176, 2}, [28] = {225, 2}, [29] = {226, 2}, [30] = {227, 2}, [31] = {228, 2}, [32] = {232, 2}, [33] = {233, 2}, [34] = {234, 2}, [35] = {235, 2}, [36] = {240, 1}, [37] = {247, 1}, [38] = {248, 1}, [39] = {249, 1}, [40] = {253, 1}, [41] = {254, 1}, [42] = {264, 1}, [43] = {265, 1}, [44] = {266, 1}, [45] = {267, 1}, [46] = {288, 1}, [47] = {311, 2}, [48] = {334, 2}},
[15] = { [1] = {116, 1}, [2] = {168, 2}, [3] = {169, 2}, [4] = {190, 2}, [5] = {233, 1}, [6] = {251, 1}, [7] = {252, 2}, [8] = {253, 2}, [9] = {254, 2}, [10] = {259, 2}, [11] = {285, 1}},
[16] = { [1] = {47, 3}, [2] = {48, 3}, [3] = {49, 3}, [4] = {50, 3}, [5] = {55, 3}, [6] = {59, 3}, [7] = {60, 3}, [8] = {63, 3}, [9] = {64, 3}, [10] = {74, 3}, [11] = {75, 3}, [12] = {79, 3}, [13] = {80, 3}, [14] = {83, 3}, [15] = {84, 3}, [16] = {85, 3}, [17] = {89, 1}, [18] = {93, 3}, [19] = {101, 1}, [20] = {102, 1}, [21] = {113, 3}, [22] = {126, 3}, [23] = {176, 2}, [24] = {182, 3}, [25] = {189, 3}, [26] = {190, 3}, [27] = {192, 3}, [28] = {195, 2}, [29] = {226, 1}, [30] = {227, 2}, [31] = {228, 2}, [32] = {229, 2}, [33] = {237, 1}, [34] = {238, 1}, [35] = {254, 1}, [36] = {255, 2}, [37] = {285, 2}, [38] = {311, 3}, [39] = {321, 1}, [40] = {322, 1}, [41] = {323, 1}, [42] = {324, 1}, [43] = {329, 2}, [44] = {334, 2}},
[17] = { [1] = {17, 3}, [2] = {81, 3}, [3] = {82, 3}, [4] = {83, 3}, [5] = {84, 3}, [6] = {114, 1}, [7] = {204, 2}, [8] = {224, 1}, [9] = {228, 2}, [10] = {229, 2}, [11] = {230, 1}, [12] = {231, 1}, [13] = {254, 2}, [14] = {263, 1}, [15] = {264, 1}, [16] = {265, 1}, [17] = {266, 1}, [18] = {310, 3}, [19] = {311, 2}, [20] = {315, 2}, [21] = {321, 2}, [22] = {322, 2}, [23] = {323, 2}, [24] = {324, 2}, [25] = {327, 2}, [26] = {328, 2}, [27] = {329, 2}, [28] = {330, 2}, [29] = {333, 2}},
[18] = { [1] = {17, 3}, [2] = {81, 3}, [3] = {82, 3}, [4] = {83, 3}, [5] = {84, 3}, [6] = {114, 1}, [7] = {203, 2}, [8] = {224, 1}, [9] = {228, 2}, [10] = {229, 2}, [11] = {230, 1}, [12] = {231, 1}, [13] = {254, 2}, [14] = {263, 1}, [15] = {264, 1}, [16] = {265, 1}, [17] = {266, 1}, [18] = {310, 3}, [19] = {311, 2}, [20] = {315, 2}, [21] = {321, 2}, [22] = {322, 2}, [23] = {323, 2}, [24] = {324, 2}, [25] = {327, 2}, [26] = {328, 2}, [27] = {329, 2}, [28] = {330, 2}, [29] = {333, 2}},
[19] = {},
[20] = { [1] = {61, 2}, [2] = {148, 2}, [3] = {175, 2}, [4] = {182, 2}, [5] = {254, 2}, [6] = {310, 2}, [7] = {327, 2}, [8] = {333, 2}},
[21] = { [1] = {27, 2}, [2] = {32, 2}, [3] = {33, 2}, [4] = {34, 2}, [5] = {37, 2}, [6] = {38, 2}, [7] = {39, 2}, [8] = {40, 2}, [9] = {58, 2}, [10] = {59, 2}, [11] = {60, 2}, [12] = {61, 2}, [13] = {63, 2}, [14] = {64, 2}, [15] = {70, 2}, [16] = {71, 2}, [17] = {83, 2}, [18] = {96, 2}, [19] = {121, 2}, [20] = {125, 2}, [21] = {129, 1}, [22] = {130, 1}},
[22] = {},
[23] = { [1] = {17, 2}, [2] = {18, 2}},
[24] = { [1] = {27, 2}, [2] = {32, 2}, [3] = {38, 2}, [4] = {39, 2}, [5] = {40, 2}, [6] = {41, 2}, [7] = {45, 2}, [8] = {48, 3}, [9] = {49, 3}, [10] = {50, 3}, [11] = {51, 3}, [12] = {56, 3}, [13] = {57, 3}, [14] = {58, 3}, [15] = {59, 3}, [16] = {66, 1}, [17] = {77, 1}, [18] = {78, 1}, [19] = {79, 1}, [20] = {80, 1}, [21] = {96, 2}, [22] = {121, 2}, [23] = {129, 1}, [24] = {130, 1}, [25] = {131, 1}, [26] = {175, 1}, [27] = {176, 1}, [28] = {184, 2}},
[25] = { [1] = {57, 2}, [2] = {58, 2}, [3] = {59, 2}, [4] = {60, 2}, [5] = {64, 2}, [6] = {65, 2}, [7] = {66, 2}, [8] = {67, 1}, [9] = {72, 1}, [10] = {211, 1}, [11] = {212, 1}},
[26] = { [1] = {20, 1}, [2] = {44, 2}, [3] = {45, 2}, [4] = {46, 2}, [5] = {47, 2}, [6] = {56, 2}, [7] = {57, 2}, [8] = {58, 2}, [9] = {59, 2}, [10] = {82, 1}, [11] = {83, 1}, [12] = {84, 1}, [13] = {85, 2}, [14] = {93, 1}, [15] = {94, 1}, [16] = {95, 1}, [17] = {96, 1}, [18] = {135, 2}, [19] = {136, 2}, [20] = {137, 2}, [21] = {138, 2}, [22] = {146, 1}, [23] = {147, 1}, [24] = {148, 1}, [25] = {149, 1}, [26] = {162, 1}, [27] = {163, 1}, [28] = {206, 2}, [29] = {221, 2}}
}

local zz = 0

for line in io.lines(filePath) do
	local tokens = {}
	local index = 0
	for token in string.gmatch(line,"[_.%w]+") do
		index = index + 1
		tokens[index] = token
	end

	if(tokens[2] == "1d") then

		zz = zz + 1

		if(zz >= 0 and zz <= 30) then

			local name = tokens[1]
			--print(name)

			local graph = {}
			local size = index/3 - 1

			for ii = 1,size do
				local triple = {}
				triple[1] = tonumber(tokens[3*ii + 1])
				triple[2] = tonumber(tokens[3*ii + 2])
				triple[3] = tonumber(tokens[3*ii + 3])
				graph[ii] = triple
			end

			local result = calculate_fdi(0, 86400, graph)

			--[[for key,value in pairs(result) do
				print(key)
				print(value[1])
				print(value[2])
				print(value[3])
		  end]]

			local tdind = 0
			for key,value in pairs(result) do
				if(value[2]) then
						local td = key-1
						tdind = tdind + 1
						assert(matlab[zz][tdind][1] == td, string.format('failed test alarm: signal num = %d, alert num = %d, got %d instead of %d', zz, tdind, td, matlab[zz][tdind][1]))
						assert(matlab[zz][tdind][2] == value[3], string.format('failed test level: signal num = %d, alert num = %d, got %d instead of %d', zz, tdind, value[3], matlab[zz][tdind][2]))
				end
			end
		  assert(tdind == table.getn(matlab[zz]), string.format('failed test: signal num = %d, entries num = %d, expected = %d',zz, tdind, table.getn(matlab[zz])))
		end
	end
end
