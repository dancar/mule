require 'calculate_fdi'

local filePath = './fdi/fixtures/graphs_of_interest.txt'
--local filePath = './fixtures/graphs_of_interest.txt'

local matlab = {
[1] = { [1] = {235, 3}, [2] = {236, 3}, [3] = {237, 3}, [4] = {241, 3}, [5] = {242, 3}, [6] = {250, 3}, [7] = {251, 3}, [8] = {256, 3}, [9] = {261, 2}, [10] = {262, 2}, [11] = {263, 1}, [12] = {266, 1}, [13] = {267, 1}, [14] = {268, 3}, [15] = {269, 1}, [16] = {273, 3}, [17] = {274, 2}, [18] = {283, 3}, [19] = {306, 3}, [20] = {307, 3}, [21] = {333, 3}, [22] = {337, 3}, [23] = {338, 3}, [24] = {351, 3}, [25] = {352, 3}, [26] = {371, 3}, [27] = {372, 3}, [28] = {373, 3}, [29] = {375, 3}, [30] = {376, 3}, [31] = {403, 2}, [32] = {404, 1}, [33] = {405, 2}, [34] = {406, 2}, [35] = {415, 2}, [36] = {416, 1}, [37] = {419, 1}, [38] = {420, 1}, [39] = {433, 2}, [40] = {489, 3}, [41] = {506, 2}, [42] = {512, 2}},
[2] = { [1] = {224, 3}, [2] = {237, 3}, [3] = {238, 3}, [4] = {243, 3}, [5] = {244, 3}, [6] = {261, 1}, [7] = {262, 2}, [8] = {263, 2}, [9] = {264, 3}, [10] = {267, 1}, [11] = {268, 3}, [12] = {269, 3}, [13] = {270, 3}, [14] = {272, 3}, [15] = {273, 3}, [16] = {296, 3}, [17] = {298, 3}, [18] = {299, 3}, [19] = {314, 3}, [20] = {327, 3}, [21] = {354, 2}, [22] = {403, 2}, [23] = {406, 2}, [24] = {407, 2}, [25] = {408, 2}, [26] = {409, 2}, [27] = {415, 2}, [28] = {416, 2}, [29] = {418, 2}, [30] = {419, 2}, [31] = {422, 1}, [32] = {489, 2}, [33] = {512, 2}},
[3] = { [1] = {223, 3}, [2] = {225, 3}, [3] = {226, 3}, [4] = {245, 3}, [5] = {246, 3}, [6] = {250, 3}, [7] = {251, 3}, [8] = {252, 3}, [9] = {256, 3}, [10] = {257, 3}, [11] = {264, 3}, [12] = {265, 3}, [13] = {276, 3}, [14] = {277, 3}, [15] = {278, 3}, [16] = {279, 3}, [17] = {283, 2}, [18] = {285, 3}, [19] = {286, 3}, [20] = {290, 1}, [21] = {291, 3}, [22] = {292, 3}, [23] = {293, 2}, [24] = {355, 1}, [25] = {382, 2}, [26] = {383, 2}, [27] = {407, 2}, [28] = {408, 2}, [29] = {412, 1}, [30] = {413, 1}, [31] = {414, 2}, [32] = {415, 1}, [33] = {432, 1}, [34] = {433, 3}, [35] = {439, 1}, [36] = {440, 1}, [37] = {441, 1}, [38] = {442, 1}, [39] = {489, 3}, [40] = {494, 2}, [41] = {500, 2}, [42] = {501, 2}, [43] = {502, 2}, [44] = {503, 2}, [45] = {507, 2}, [46] = {509, 2}, [47] = {510, 2}, [48] = {511, 2}, [49] = {512, 2}},
[4] = { [1] = {196, 1}, [2] = {197, 1}, [3] = {203, 1}, [4] = {204, 1}, [5] = {231, 1}, [6] = {253, 2}, [7] = {324, 1}, [8] = {325, 1}, [9] = {326, 1}, [10] = {327, 1}, [11] = {489, 2}},
[5] = { [1] = {176, 2}, [2] = {181, 1}, [3] = {182, 1}, [4] = {183, 1}, [5] = {220, 3}, [6] = {261, 2}, [7] = {262, 2}, [8] = {263, 2}, [9] = {264, 2}, [10] = {353, 1}, [11] = {354, 2}, [12] = {355, 1}, [13] = {361, 1}, [14] = {403, 2}, [15] = {406, 2}, [16] = {407, 1}, [17] = {408, 2}, [18] = {409, 2}, [19] = {415, 2}, [20] = {416, 1}, [21] = {418, 2}, [22] = {419, 2}, [23] = {422, 1}, [24] = {423, 1}, [25] = {466, 1}, [26] = {480, 1}, [27] = {489, 2}, [28] = {497, 1}, [29] = {498, 1}, [30] = {499, 1}, [31] = {500, 1}, [32] = {512, 1}},
[6] = { [1] = {504, 3}, [2] = {505, 3}, [3] = {511, 3}, [4] = {512, 3}},
[7] = { [1] = {227, 1}, [2] = {232, 1}, [3] = {260, 3}, [4] = {261, 3}, [5] = {265, 1}, [6] = {266, 1}, [7] = {267, 1}, [8] = {280, 1}, [9] = {282, 2}, [10] = {320, 3}, [11] = {321, 3}, [12] = {329, 3}, [13] = {330, 3}, [14] = {333, 3}, [15] = {346, 2}, [16] = {349, 1}, [17] = {350, 2}, [18] = {351, 2}, [19] = {352, 2}, [20] = {356, 1}, [21] = {357, 1}, [22] = {358, 1}, [23] = {362, 1}, [24] = {363, 1}, [25] = {364, 1}, [26] = {365, 1}, [27] = {368, 2}, [28] = {369, 2}, [29] = {370, 2}, [30] = {371, 1}, [31] = {381, 1}, [32] = {382, 1}, [33] = {383, 1}, [34] = {406, 1}, [35] = {407, 1}, [36] = {408, 1}, [37] = {409, 1}, [38] = {419, 1}, [39] = {420, 1}, [40] = {429, 1}, [41] = {436, 2}, [42] = {437, 2}, [43] = {464, 1}, [44] = {465, 1}, [45] = {466, 1}, [46] = {489, 2}, [47] = {493, 1}, [48] = {502, 1}, [49] = {503, 1}, [50] = {504, 1}, [51] = {505, 1}},
[8] = { [1] = {221, 3}, [2] = {222, 3}, [3] = {254, 3}, [4] = {255, 3}, [5] = {260, 3}, [6] = {262, 3}, [7] = {263, 3}, [8] = {270, 3}, [9] = {271, 3}, [10] = {277, 3}, [11] = {278, 3}, [12] = {279, 1}, [13] = {280, 1}, [14] = {311, 3}, [15] = {312, 3}, [16] = {313, 3}, [17] = {337, 2}, [18] = {349, 1}, [19] = {353, 1}, [20] = {354, 2}, [21] = {355, 1}, [22] = {356, 1}, [23] = {358, 3}, [24] = {369, 1}, [25] = {370, 1}, [26] = {371, 1}, [27] = {372, 1}, [28] = {375, 1}, [29] = {376, 1}, [30] = {377, 1}, [31] = {378, 1}, [32] = {414, 1}, [33] = {433, 2}, [34] = {464, 1}, [35] = {489, 3}, [36] = {506, 1}, [37] = {511, 1}, [38] = {512, 2}},
[9] = { [1] = {220, 3}, [2] = {226, 3}, [3] = {239, 3}, [4] = {240, 3}, [5] = {242, 3}, [6] = {243, 3}, [7] = {248, 3}, [8] = {249, 3}, [9] = {250, 3}, [10] = {264, 3}, [11] = {265, 3}, [12] = {266, 3}, [13] = {267, 3}, [14] = {273, 3}, [15] = {274, 3}, [16] = {283, 1}, [17] = {284, 3}, [18] = {288, 3}, [19] = {289, 3}, [20] = {290, 3}, [21] = {294, 3}, [22] = {295, 3}, [23] = {299, 3}, [24] = {301, 3}, [25] = {302, 3}, [26] = {303, 3}, [27] = {309, 2}, [28] = {326, 3}, [29] = {327, 3}, [30] = {348, 1}, [31] = {349, 1}, [32] = {350, 2}, [33] = {351, 2}, [34] = {355, 1}, [35] = {360, 3}, [36] = {361, 3}, [37] = {362, 3}, [38] = {368, 3}, [39] = {369, 3}, [40] = {370, 1}, [41] = {371, 1}, [42] = {373, 3}, [43] = {374, 3}, [44] = {383, 1}, [45] = {414, 1}, [46] = {428, 1}, [47] = {433, 2}, [48] = {464, 1}, [49] = {489, 3}, [50] = {505, 1}, [51] = {506, 1}, [52] = {510, 1}, [53] = {511, 1}, [54] = {512, 2}},
[10] = { [1] = {220, 3}, [2] = {224, 3}, [3] = {225, 3}, [4] = {229, 3}, [5] = {230, 3}, [6] = {235, 3}, [7] = {236, 3}, [8] = {262, 1}, [9] = {263, 1}, [10] = {264, 1}, [11] = {265, 1}, [12] = {272, 2}, [13] = {273, 2}, [14] = {274, 2}, [15] = {275, 2}, [16] = {280, 2}, [17] = {281, 2}, [18] = {282, 2}, [19] = {283, 2}, [20] = {294, 3}, [21] = {295, 3}, [22] = {296, 3}, [23] = {325, 3}, [24] = {326, 3}, [25] = {353, 1}, [26] = {354, 2}, [27] = {355, 1}, [28] = {388, 1}, [29] = {405, 1}, [30] = {406, 1}, [31] = {407, 1}, [32] = {408, 1}, [33] = {416, 1}, [34] = {419, 1}, [35] = {424, 1}, [36] = {425, 1}, [37] = {426, 1}, [38] = {433, 2}, [39] = {478, 1}, [40] = {479, 1}, [41] = {489, 2}, [42] = {496, 2}, [43] = {497, 2}, [44] = {498, 2}, [45] = {499, 2}, [46] = {501, 2}, [47] = {502, 2}, [48] = {503, 2}, [49] = {504, 2}, [50] = {508, 2}, [51] = {512, 2}},
[11] = { [1] = {436, 3}, [2] = {437, 3}, [3] = {438, 3}, [4] = {439, 3}, [5] = {489, 3}, [6] = {512, 2}},
[12] = { [1] = {233, 3}, [2] = {234, 3}, [3] = {261, 2}, [4] = {262, 2}, [5] = {263, 2}, [6] = {264, 2}, [7] = {268, 3}, [8] = {269, 3}, [9] = {280, 3}, [10] = {281, 3}, [11] = {282, 3}, [12] = {403, 2}, [13] = {406, 1}, [14] = {407, 1}, [15] = {408, 1}, [16] = {409, 1}, [17] = {415, 2}, [18] = {416, 2}, [19] = {418, 2}, [20] = {419, 2}, [21] = {420, 2}, [22] = {422, 2}, [23] = {423, 2}, [24] = {424, 2}, [25] = {425, 2}, [26] = {489, 2}, [27] = {512, 2}},
[13] = { [1] = {398, 1}, [2] = {399, 1}, [3] = {400, 1}, [4] = {404, 1}, [5] = {405, 1}, [6] = {410, 1}, [7] = {411, 1}, [8] = {412, 1}, [9] = {433, 2}, [10] = {489, 2}, [11] = {512, 2}},
[14] = { [1] = {227, 3}, [2] = {228, 3}, [3] = {230, 3}, [4] = {231, 3}, [5] = {243, 3}, [6] = {248, 3}, [7] = {249, 3}, [8] = {254, 3}, [9] = {261, 1}, [10] = {262, 2}, [11] = {263, 2}, [12] = {264, 2}, [13] = {272, 3}, [14] = {273, 3}, [15] = {274, 3}, [16] = {278, 3}, [17] = {279, 3}, [18] = {283, 3}, [19] = {293, 3}, [20] = {294, 3}, [21] = {296, 3}, [22] = {304, 3}, [23] = {305, 3}, [24] = {340, 2}, [25] = {341, 1}, [26] = {350, 3}, [27] = {354, 2}, [28] = {403, 2}, [29] = {404, 2}, [30] = {405, 2}, [31] = {406, 2}, [32] = {410, 2}, [33] = {411, 2}, [34] = {412, 2}, [35] = {413, 2}, [36] = {418, 1}, [37] = {425, 1}, [38] = {426, 1}, [39] = {427, 1}, [40] = {431, 1}, [41] = {432, 1}, [42] = {442, 1}, [43] = {443, 1}, [44] = {444, 1}, [45] = {445, 1}, [46] = {466, 1}, [47] = {489, 2}, [48] = {512, 2}},
[15] = { [1] = {295, 1}, [2] = {347, 2}, [3] = {348, 2}, [4] = {369, 2}, [5] = {412, 1}, [6] = {430, 1}, [7] = {431, 2}, [8] = {432, 2}, [9] = {433, 2}, [10] = {438, 2}, [11] = {464, 1}},
[16] = { [1] = {225, 3}, [2] = {226, 3}, [3] = {227, 3}, [4] = {228, 3}, [5] = {233, 3}, [6] = {237, 3}, [7] = {238, 3}, [8] = {241, 3}, [9] = {242, 3}, [10] = {252, 3}, [11] = {253, 3}, [12] = {257, 3}, [13] = {258, 3}, [14] = {261, 3}, [15] = {262, 3}, [16] = {263, 3}, [17] = {267, 1}, [18] = {271, 3}, [19] = {279, 1}, [20] = {280, 1}, [21] = {291, 3}, [22] = {304, 3}, [23] = {354, 2}, [24] = {360, 3}, [25] = {367, 3}, [26] = {368, 3}, [27] = {370, 3}, [28] = {373, 2}, [29] = {404, 1}, [30] = {405, 2}, [31] = {406, 2}, [32] = {407, 2}, [33] = {415, 1}, [34] = {416, 1}, [35] = {432, 1}, [36] = {433, 2}, [37] = {463, 2}, [38] = {489, 3}, [39] = {499, 1}, [40] = {500, 1}, [41] = {501, 1}, [42] = {502, 1}, [43] = {507, 2}, [44] = {512, 2}},
[17] = { [1] = {196, 3}, [2] = {260, 3}, [3] = {261, 3}, [4] = {262, 3}, [5] = {263, 3}, [6] = {293, 1}, [7] = {383, 2}, [8] = {403, 1}, [9] = {407, 2}, [10] = {408, 2}, [11] = {409, 1}, [12] = {410, 1}, [13] = {433, 2}, [14] = {442, 1}, [15] = {443, 1}, [16] = {444, 1}, [17] = {445, 1}, [18] = {489, 3}, [19] = {490, 2}, [20] = {494, 2}, [21] = {500, 2}, [22] = {501, 2}, [23] = {502, 2}, [24] = {503, 2}, [25] = {506, 2}, [26] = {507, 2}, [27] = {508, 2}, [28] = {509, 2}, [29] = {512, 2}},
[18] = { [1] = {196, 3}, [2] = {260, 3}, [3] = {261, 3}, [4] = {262, 3}, [5] = {263, 3}, [6] = {293, 1}, [7] = {382, 2}, [8] = {403, 1}, [9] = {407, 2}, [10] = {408, 2}, [11] = {409, 1}, [12] = {410, 1}, [13] = {433, 2}, [14] = {442, 1}, [15] = {443, 1}, [16] = {444, 1}, [17] = {445, 1}, [18] = {489, 3}, [19] = {490, 2}, [20] = {494, 2}, [21] = {500, 2}, [22] = {501, 2}, [23] = {502, 2}, [24] = {503, 2}, [25] = {506, 2}, [26] = {507, 2}, [27] = {508, 2}, [28] = {509, 2}, [29] = {512, 2}},
[19] = {},
[20] = { [1] = {240, 2}, [2] = {327, 2}, [3] = {354, 2}, [4] = {361, 2}, [5] = {433, 2}, [6] = {489, 2}, [7] = {506, 2}, [8] = {512, 2}},
[21] = { [1] = {489, 2}, [2] = {494, 2}, [3] = {495, 2}, [4] = {496, 2}, [5] = {499, 2}, [6] = {500, 2}, [7] = {501, 2}, [8] = {502, 2}, [9] = {520, 2}, [10] = {521, 2}, [11] = {522, 2}, [12] = {523, 2}, [13] = {525, 2}, [14] = {526, 2}, [15] = {532, 2}, [16] = {533, 2}, [17] = {545, 2}, [18] = {558, 2}, [19] = {583, 2}, [20] = {587, 2}, [21] = {591, 1}, [22] = {592, 1}},
[22] = {},
[23] = { [1] = {536, 2}, [2] = {537, 2}},
[24] = { [1] = {489, 2}, [2] = {494, 2}, [3] = {500, 2}, [4] = {501, 2}, [5] = {502, 2}, [6] = {503, 2}, [7] = {507, 2}, [8] = {510, 3}, [9] = {511, 3}, [10] = {512, 3}, [11] = {513, 3}, [12] = {518, 3}, [13] = {519, 3}, [14] = {520, 3}, [15] = {521, 3}, [16] = {528, 1}, [17] = {539, 1}, [18] = {540, 1}, [19] = {541, 1}, [20] = {542, 1}, [21] = {558, 2}, [22] = {583, 2}, [23] = {591, 1}, [24] = {592, 1}, [25] = {593, 1}, [26] = {637, 1}, [27] = {638, 1}, [28] = {646, 2}},
[25] = { [1] = {521, 2}, [2] = {522, 2}, [3] = {523, 2}, [4] = {524, 2}, [5] = {528, 2}, [6] = {529, 2}, [7] = {530, 2}, [8] = {531, 1}, [9] = {536, 1}, [10] = {675, 1}, [11] = {676, 1}},
[26] = { [1] = {482, 1}, [2] = {506, 2}, [3] = {507, 2}, [4] = {508, 2}, [5] = {509, 2}, [6] = {518, 2}, [7] = {519, 2}, [8] = {520, 2}, [9] = {521, 2}, [10] = {544, 1}, [11] = {545, 1}, [12] = {546, 1}, [13] = {547, 2}, [14] = {555, 1}, [15] = {556, 1}, [16] = {557, 1}, [17] = {558, 1}, [18] = {597, 2}, [19] = {598, 2}, [20] = {599, 2}, [21] = {600, 2}, [22] = {608, 1}, [23] = {609, 1}, [24] = {610, 1}, [25] = {611, 1}, [26] = {624, 1}, [27] = {625, 1}, [28] = {668, 2}, [29] = {683, 2}}
}

local zz = 0

for line in io.lines(filePath) do
	local tokens = {}
	local index = 0
	for token in string.gmatch(line,"[_.%w]+") do
		index = index + 1
		tokens[index] = token
	end

	if(tokens[2] == "1d") then

		zz = zz + 1

		if(zz >= 0 and zz <= 30) then

			local name = tokens[1]
			--print(name)

			local graph = {}
			local size = index/3 - 1

			for ii = 1,size do
				local triple = {}
				triple[1] = tonumber(tokens[3*ii + 1])
				triple[2] = tonumber(tokens[3*ii + 2])
				triple[3] = tonumber(tokens[3*ii + 3])
				graph[ii] = triple
			end

			local result = calculate_fdi(0, 86400, graph)

			--[[for key,value in pairs(result) do
				print(key)
				print(value[1])
				print(value[2])
				print(value[3])
		  end]]

			local tdind = 0
			for key,value in pairs(result) do
				if(value[2]) then
						local td = (value[1] - 1357344000) / 86400
						tdind = tdind + 1
						assert(matlab[zz][tdind][1] == td, string.format('failed test alarm: signal num = %d, alert num = %d, got %d instead of %d', zz, tdind, td, matlab[zz][tdind][1]))
						assert(matlab[zz][tdind][2] == value[3], string.format('failed test level: signal num = %d, alert num = %d, got %d instead of %d', zz, tdind, value[3], matlab[zz][tdind][2]))
				end
			end

		end
	end
end
